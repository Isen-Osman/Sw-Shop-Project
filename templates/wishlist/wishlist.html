{% extends 'partials/base.html' %}

{% block title %}Кошничка | Modern Shop{% endblock %}

{% block content %}
    <style>
        /* Стилови за loading модал */
        .loading-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .loading-bar-container {
            width: 100%;
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #ec4899, #f472b6);
            width: 0%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .loading-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .loading-subtext {
    font-size: 14px;
    color: #666;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}


        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            position: relative;
        }

        .spinner-circle {
            width: 100%;
            height: 100%;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-percentage {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ec4899;
            margin: 1rem 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin: 1rem 0;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #ec4899;
            border-radius: 50%;
            animation: dot-pulse 1.5s infinite ease-in-out;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dot-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }
    </style>

    <!-- Loading модал -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-circle"></div>
            </div>
            <div class="loading-text">Креирање нарачка</div>
            <p class="loading-subtext">Ве молиме почекајте...</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-10">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl sm:text-3xl font-bold text-gray-900">
                Твојата Кошничка
            </h1>
            {% if products_with_sizes|length > 0 %}
                <p class="text-gray-500 mt-2 text-sm sm:text-base">{{ products_with_sizes|length }} производи</p>
            {% endif %}
        </div>

        {% if products_with_sizes|length > 0 %}
            <!-- Cart Items -->
            <div class="divide-y divide-gray-200 mb-8">
                {% for item in products_with_sizes %}
                    <div class="mt-8">
                        <ul class="space-y-4">
                            <li class="flex items-center gap-4">
                                <img src="{{ item.product.images.first.image.url }}"
                                     alt="{{ item.product.name }}"
                                     class="size-16 rounded-sm object-cover"/>

                                <div>
                                    <h3 class="text-sm text-gray-900">{{ item.product.name }}</h3>

                                    <dl class="mt-0.5 space-y-px text-[10px] text-gray-600">
                                        <div>
                                            <dt class="inline">Големина:</dt>
                                            <dd class="inline">{{ item.size }}</dd>
                                        </div>
                                        <div>
                                            <dt class="inline">Боја:</dt>
                                            <dd class="inline normal-case">{{ item.product.color }}</dd>
                                        </div>
                                    </dl>
                                </div>

                                <div class="flex flex-1 items-center justify-end gap-2">
                                    <div class="border border-white rounded-0 me-5">
                                        <dd class="inline normal-case px-2">{{ item.quantity }}</dd>
                                    </div>

                                    <button class="text-gray-600 transition hover:text-red-600"
                                            onclick="window.location.href='{% url 'wishlist_remove_with_size' item.product.id item.size %}'">
                                        <span class="sr-only">Remove item</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                             stroke-width="1.5" stroke="currentColor" class="size-4">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                  d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166
                                                 m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084
                                                 a2.25 2.25 0 01-2.244-2.077L4.772 5.79
                                                 m14.456 0a48.108 48.108 0 00-3.478-.397
                                                 m-12 .562c.34-.059.68-.114 1.022-.165
                                                 m0 0a48.11 48.11 0 013.478-.397
                                                 m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201
                                                 a51.964 51.964 0 00-3.32 0
                                                 c-1.18.037-2.09 1.022-2.09 2.201v.916
                                                 m7.5 0a48.667 48.667 0 00-7.5 0"/>
                                        </svg>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                {% endfor %}
            </div>

            <!-- Price Summary -->
            <div class="mt-8 flex justify-end border-t border-gray-100 pt-8">
                <div class="w-screen max-w-lg space-y-4">
                    <dl class="space-y-0.5 text-sm text-gray-700">
                        <div class="flex justify-between items-center">
                            <dt class="bg-red-500 text-white text-sm font-semibold px-2 py-1 rounded-md">% Цена со Попуст</dt>
                            <dd class="text-red-600 font-medium">
                                {{ total_price }} ден
                            </dd>
                        </div>
                    </dl>

                    <div class="flex justify-between mt-5 gap-5">
                        <button class="flex items-center gap-2 rounded-xl bg-gray-200 px-5 py-3 text-sm text-dark"
                                onclick="window.location.href='{% url 'products' %}'">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke-width="1.5" stroke="currentColor" class="size-5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"/>
                            </svg>
                            Назад кон пазарење
                        </button>

                        <button type="button" id="createOrderBtn"
                                class="flex items-center gap-2 rounded-xl bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 px-5 py-3 text-sm text-white pulse">
                            Направи Нарачка
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke-width="1.5" stroke="currentColor" class="size-5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

        {% else %}
            <!-- Empty State -->
            <div class="bg-white rounded-2xl shadow-lg p-8 sm:p-12 text-center">
                <div class="mx-auto w-20 h-20 sm:w-24 sm:h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6 text-gray-400">
                    <svg class="w-10 h-10 sm:w-12 sm:h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                    </svg>
                </div>
                <h3 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-3">Вашата кошничка е празна</h3>
                <p class="text-gray-500 mb-6 sm:mb-8 text-sm sm:text-base">Додадете производи за да ги видите овде 👇</p>
                <a href="{% url 'products' %}"
                   class="inline-block bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white font-semibold px-4 sm:px-6 py-2 sm:py-3 rounded-xl shadow-md transition text-sm sm:text-base">
                    Разгледај производи
                </a>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createOrderBtn = document.getElementById('createOrderBtn');
            const loadingModal = document.getElementById('loadingModal');
            const loadingBar = document.getElementById('loadingBar');
            const loadingPercentage = document.getElementById('loadingPercentage');

            if (createOrderBtn) {
                createOrderBtn.addEventListener('click', function() {
                    // Прикажи го loading модалот
                    loadingModal.style.display = 'flex';

                    // Започни со loading анимација
                    startLoadingAnimation();
                });
            }

            function startLoadingAnimation() {
                let progress = 0;
                const targetProgress = 100;
                const duration = 1000; // 3 секунди вкупно
                const interval = 30; // Ажурирај на секои 30ms
                const increment = (interval / duration) * targetProgress;

                const loadingInterval = setInterval(() => {
                    if (progress < targetProgress) {
                        progress += increment;
                        if (progress > targetProgress) progress = targetProgress;

                        // Ажурирај го loading bar-от
                        loadingBar.style.width = progress + '%';
                        loadingPercentage.textContent = Math.round(progress) + '%';
                    } else {
                        clearInterval(loadingInterval);

                        // Почекај малку на 100% пред пренасочување
                        setTimeout(() => {
                            // Испрати формата
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = '{% url "create_order" %}';

                            const csrfToken = document.createElement('input');
                            csrfToken.type = 'hidden';
                            csrfToken.name = 'csrfmiddlewaretoken';
                            csrfToken.value = '{{ csrf_token }}';
                            form.appendChild(csrfToken);

                            document.body.appendChild(form);
                            form.submit();
                        }, 500);
                    }
                }, interval);
            }

            // Затвори модал при клик надвор од содржината
            loadingModal.addEventListener('click', function(e) {
                if (e.target === loadingModal) {
                    loadingModal.style.display = 'none';
                }
            });
        });
    </script>
{% endblock %}